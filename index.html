<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>PSY 6422 Project</title>

<script src="index_files/header-attrs-2.29/header-attrs.js"></script>
<script src="index_files/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="index_files/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="index_files/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="index_files/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="index_files/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="index_files/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="index_files/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="index_files/tocify-1.9.1/jquery.tocify.js"></script>
<script src="index_files/navigation-1.1/tabsets.js"></script>
<script src="index_files/navigation-1.1/codefolding.js"></script>
<link rel="icon" type="image/png" href="images/favicon.ico"/>

<div class="hero-image"> 
        <div class="image-text">
          <div class="top-text">PSY 6422</div>
            <div class="bottom-text">Train cancellations in Great Britain</div>
        </div>
</div>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; } /* Alert */
code span.an { color: #008000; } /* Annotation */
code span.at { } /* Attribute */
code span.bu { } /* BuiltIn */
code span.cf { color: #0000ff; } /* ControlFlow */
code span.ch { color: #008080; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #008000; } /* Comment */
code span.cv { color: #008000; } /* CommentVar */
code span.do { color: #008000; } /* Documentation */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.im { } /* Import */
code span.in { color: #008000; } /* Information */
code span.kw { color: #0000ff; } /* Keyword */
code span.op { } /* Operator */
code span.ot { color: #ff4000; } /* Other */
code span.pp { color: #ff4000; } /* Preprocessor */
code span.sc { color: #008080; } /* SpecialChar */
code span.ss { color: #008080; } /* SpecialString */
code span.st { color: #008080; } /* String */
code span.va { } /* Variable */
code span.vs { color: #008080; } /* VerbatimString */
code span.wa { color: #008000; font-weight: bold; } /* Warning */

.sourceCode .row {
  width: 100%;
}
.sourceCode {
  overflow-x: auto;
}
.code-folding-btn {
  margin-right: -30px;
}
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">
/* for pandoc --citeproc since 2.11 */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>



<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">PSY 6422 Project</h1>
<h4 class="author"><div class="line-block">Kim Idar Giske<br />
Registration number: 240196505</div></h4>
<h4 class="date">November 11th, 2024</h4>

</div>


<div id="project-statement" class="section level1" number="1">
<h1><span class="header-section-number">1</span> Project Statement</h1>
<p>The idea for this project was borne out of the frustrations of the
author in dealing with a railway commute in Great Britain. More
specifically, the question asked was <strong>How many trains are
cancelled each day in Great Britain?</strong></p>
</div>
<div id="environment-and-libraries" class="section level1" number="2">
<h1><span class="header-section-number">2</span> Environment and
Libraries</h1>
<p>In order to ensure a reproducible environment, this project makes use
of <em>renv</em> to manage its dependencies. Once <em>renv</em> has
restored the environment the project was created in, the required
libraries will be loaded.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co"># Restore dependencies with renv</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;renv&quot;</span>)) {</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>    <span class="fu">install.packages</span>(<span class="st">&quot;renv&quot;</span>)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>}</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="fu">library</span>(renv)</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>renv<span class="sc">::</span><span class="fu">restore</span>()</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="co"># Load required libraries</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="fu">library</span>(circlize)</span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="fu">library</span>(ComplexHeatmap)</span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="fu">library</span>(cowplot)</span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a><span class="fu">library</span>(janitor)</span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a><span class="fu">library</span>(plyr)</span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a><span class="fu">library</span>(spiralize)</span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code></pre></div>
<div class="info">
<p><em>ComplexHeatmap and spiralize require installation from Github
rather than CRAN. If any issues arise during the environment
restoration, the following devtools commands can be used to install the
libraries:</em> <br />
devtools::install_github(“jokergoo/ComplexHeatmap”) <br />
devtools::install_github(“jokergoo/spiralize”)</p>
</div>
</div>
<div id="data-origins" class="section level1" number="3">
<h1><span class="header-section-number">3</span> Data Origins</h1>
<p>The data used in this project was obtained from the <a
href="https://raildata.org.uk/dashboard/dataProduct/P-3fade1ab-0a85-4ac6-bc51-17c770350af3/dataFiles">NWR
Historic Delay Attribution</a> data set, licensed under the <a
href="https://raildata.org.uk/dashboard/dataProduct/P-3fade1ab-0a85-4ac6-bc51-17c770350af3/termsAndConditions">Open
Government Licence v3.0</a> on the <a
href="https://raildata.org.uk">Rail Data Marketplace</a>. It contains
all the delay and cancellation data for all railway operators in Great
Britain, ranging from, at the time of writing, the 2015-2016 fiscal year
up until October 12th 2024 <span class="citation">(<a
href="#ref-NWRDelay">Rail Delivery Group, 2024</a>)</span>.</p>
<div id="variables" class="section level2" number="3.1">
<h2><span class="header-section-number">3.1</span> Variables</h2>
<p>These are the variables included in this project. Not all of them
ended up being used in the final visualisation, but have been retained
to allow for different types of analyses or graphs in any future
adaptations of this project. Refer to the code book for more details on
these variables.</p>
<table class="striped">
<thead>
<tr>
<th style="text-align:left;">
Variable
</th>
<th style="text-align:left;">
Description
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
departure_date
</td>
<td style="text-align:left;">
The date of the cancellation
</td>
</tr>
<tr>
<td style="text-align:left;">
event_type
</td>
<td style="text-align:left;">
The type of cancellation
</td>
</tr>
<tr>
<td style="text-align:left;">
react_reason
</td>
<td style="text-align:left;">
The reason for the cancellation
</td>
</tr>
<tr>
<td style="text-align:left;">
toc_code
</td>
<td style="text-align:left;">
The train operator
</td>
</tr>
<tr>
<td style="text-align:left;">
stanox
</td>
<td style="text-align:left;">
The numerical code for the point of origin
</td>
</tr>
</tbody>
</table>
</div>
<div id="reading-the-data" class="section level2" number="3.2">
<h2><span class="header-section-number">3.2</span> Reading the Data</h2>
<p>The first step is to read and clean the raw data. At the time this
project was completed a total of 124 files covering the time period
between April 1st 2015 and October 12th 2024 were used.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># Create a list of train operator codes (TOC) for passenger train operators to</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="co"># filter out the relevant observations</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>tocs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;EA&quot;</span>, <span class="st">&quot;EB&quot;</span>, <span class="st">&quot;EC&quot;</span>, <span class="st">&quot;ED&quot;</span>, <span class="st">&quot;EE&quot;</span>, <span class="st">&quot;EF&quot;</span>, <span class="st">&quot;EH&quot;</span>, <span class="st">&quot;EJ&quot;</span>, <span class="st">&quot;EK&quot;</span>, <span class="st">&quot;EM&quot;</span>, <span class="st">&quot;ES&quot;</span>, <span class="st">&quot;ET&quot;</span>,</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>    <span class="st">&quot;EX&quot;</span>, <span class="st">&quot;HA&quot;</span>, <span class="st">&quot;HB&quot;</span>, <span class="st">&quot;HE&quot;</span>, <span class="st">&quot;HF&quot;</span>, <span class="st">&quot;HL&quot;</span>, <span class="st">&quot;HM&quot;</span>, <span class="st">&quot;HO&quot;</span>, <span class="st">&quot;HT&quot;</span>, <span class="st">&quot;HU&quot;</span>, <span class="st">&quot;HX&quot;</span>, <span class="st">&quot;HY&quot;</span>, <span class="st">&quot;LD&quot;</span>,</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>    <span class="st">&quot;LN&quot;</span>, <span class="st">&quot;PF&quot;</span>, <span class="st">&quot;XB&quot;</span>, <span class="st">&quot;XC&quot;</span>, <span class="st">&quot;XE&quot;</span>)</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="co"># Create a list of column names that need to be renamed</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>rename_cols <span class="ot">=</span> <span class="fu">c</span>(<span class="at">toc_code =</span> <span class="st">&quot;operator_affected&quot;</span>, <span class="at">event_type =</span> <span class="st">&quot;performance_event_code&quot;</span>,</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>    <span class="at">react_reason =</span> <span class="st">&quot;reactionary_reason_code&quot;</span>, <span class="at">stanox =</span> <span class="st">&quot;start_stanox&quot;</span>)</span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a><span class="co"># Read file names in the raw data folder</span></span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>csvfiles <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">list.files</span>(<span class="at">path =</span> <span class="st">&quot;raw&quot;</span>, <span class="at">pattern =</span> <span class="st">&quot;</span><span class="sc">\\</span><span class="st">.csv$&quot;</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>))</span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a><span class="co"># Create a list to populate with data frames</span></span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>train_frame <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a><span class="co"># Use a loop to read the files.</span></span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(csvfiles)) {</span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a>    <span class="co"># Create a csv reader function</span></span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a>    train_reader <span class="ot">&lt;-</span> <span class="cf">function</span>(filelist) {</span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a>        <span class="co"># Read the files using fread</span></span>
<span id="cb2-24"><a href="#cb2-24" tabindex="-1"></a>        plyr<span class="sc">::</span><span class="fu">ldply</span>(filelist, fread) <span class="sc">%&gt;%</span></span>
<span id="cb2-25"><a href="#cb2-25" tabindex="-1"></a>            <span class="co"># Convert column names to snake case using janitor</span></span>
<span id="cb2-26"><a href="#cb2-26" tabindex="-1"></a>        <span class="fu">clean_names</span>() <span class="sc">%&gt;%</span></span>
<span id="cb2-27"><a href="#cb2-27" tabindex="-1"></a>            <span class="co"># Rename columns</span></span>
<span id="cb2-28"><a href="#cb2-28" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="fu">any_of</span>(rename_cols)) <span class="sc">%&gt;%</span></span>
<span id="cb2-29"><a href="#cb2-29" tabindex="-1"></a>            <span class="co"># Drop observations that contain delay data and planned</span></span>
<span id="cb2-30"><a href="#cb2-30" tabindex="-1"></a>            <span class="co"># cancellations</span></span>
<span id="cb2-31"><a href="#cb2-31" tabindex="-1"></a>        <span class="fu">filter</span>(event_type <span class="sc">!=</span> <span class="st">&quot;M&quot;</span> <span class="sc">&amp;</span> event_type <span class="sc">!=</span> <span class="st">&quot;F&quot;</span> <span class="sc">&amp;</span> event_type <span class="sc">!=</span> <span class="st">&quot;A&quot;</span> <span class="sc">&amp;</span> event_type <span class="sc">!=</span></span>
<span id="cb2-32"><a href="#cb2-32" tabindex="-1"></a>            <span class="st">&quot;O&quot;</span> <span class="sc">&amp;</span> event_type <span class="sc">!=</span> <span class="st">&quot;S&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-33"><a href="#cb2-33" tabindex="-1"></a>            <span class="co"># Filter by passenger train operators</span></span>
<span id="cb2-34"><a href="#cb2-34" tabindex="-1"></a>        <span class="fu">filter</span>(toc_code <span class="sc">%in%</span> tocs) <span class="sc">%&gt;%</span></span>
<span id="cb2-35"><a href="#cb2-35" tabindex="-1"></a>            <span class="co"># Convert the date format using lubridate</span></span>
<span id="cb2-36"><a href="#cb2-36" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">departure_date =</span> <span class="fu">parse_date_time</span>(origin_departure_date, <span class="fu">c</span>(<span class="st">&quot;dmy&quot;</span>, <span class="st">&quot;%d/%m/%Y %H%M&quot;</span>)),</span>
<span id="cb2-37"><a href="#cb2-37" tabindex="-1"></a>            <span class="at">.before =</span> origin_departure_date) <span class="sc">%&gt;%</span></span>
<span id="cb2-38"><a href="#cb2-38" tabindex="-1"></a>            <span class="co"># Change data type to date</span></span>
<span id="cb2-39"><a href="#cb2-39" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">departure_date =</span> <span class="fu">as.Date</span>(departure_date)) <span class="sc">%&gt;%</span></span>
<span id="cb2-40"><a href="#cb2-40" tabindex="-1"></a>            <span class="co"># Keep only the columns we are interested</span></span>
<span id="cb2-41"><a href="#cb2-41" tabindex="-1"></a>        <span class="fu">select</span>(departure_date, toc_code, event_type, react_reason, stanox)</span>
<span id="cb2-42"><a href="#cb2-42" tabindex="-1"></a>    }</span>
<span id="cb2-43"><a href="#cb2-43" tabindex="-1"></a></span>
<span id="cb2-44"><a href="#cb2-44" tabindex="-1"></a>    <span class="co"># Populate the list</span></span>
<span id="cb2-45"><a href="#cb2-45" tabindex="-1"></a>    train_frame[[i]] <span class="ot">&lt;-</span> <span class="fu">train_reader</span>(csvfiles[i])</span>
<span id="cb2-46"><a href="#cb2-46" tabindex="-1"></a>}</span>
<span id="cb2-47"><a href="#cb2-47" tabindex="-1"></a></span>
<span id="cb2-48"><a href="#cb2-48" tabindex="-1"></a><span class="co"># Reduce the large list to a single data frame using purrr</span></span>
<span id="cb2-49"><a href="#cb2-49" tabindex="-1"></a>master_df <span class="ot">&lt;-</span> train_frame <span class="sc">%&gt;%</span></span>
<span id="cb2-50"><a href="#cb2-50" tabindex="-1"></a>    <span class="fu">reduce</span>(full_join)</span></code></pre></div>
</div>
<div id="sanity-check" class="section level2" number="3.3">
<h2><span class="header-section-number">3.3</span> Sanity Check</h2>
<p>Sanity check to see if the data was read correctly. The range of
dates should be from April 1st 2015 until October 12th 2024 and be a
total of 3482 days.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># Sanity check</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">&quot;master_df begins at&quot;</span>, <span class="fu">min</span>(master_df<span class="sc">$</span>departure_date), <span class="st">&quot;and ends at&quot;</span>,</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>    <span class="fu">max</span>(master_df<span class="sc">$</span>departure_date), <span class="st">&quot;and consists of&quot;</span>, <span class="fu">length</span>(<span class="fu">unique</span>(master_df<span class="sc">$</span>departure_date)),</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>    <span class="st">&quot;days of observations&quot;</span>))</span></code></pre></div>
<pre><code>## [1] &quot;master_df begins at 2015-04-01 and ends at 2024-10-12 and consists of 3482 days of observations&quot;</code></pre>
</div>
<div id="descriptors" class="section level2" number="3.4">
<h2><span class="header-section-number">3.4</span> Descriptors</h2>
<p>This section is not strictly necessary for the project, but has been
included for transparency and readability. This code will add
descriptors for the variables in the data frame and save it as a csv
file, which allows for access to the data used in the project without
needing to obtain access to the Rail Data Marketplace.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co"># Create a train operator data frame. This is easier than reading it from the</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="co"># glossary as it contains freight operators which we are not interested in</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>operators <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">toc_code =</span> <span class="fu">c</span>(<span class="st">&quot;EA&quot;</span>, <span class="st">&quot;EB&quot;</span>, <span class="st">&quot;EC&quot;</span>, <span class="st">&quot;ED&quot;</span>, <span class="st">&quot;EE&quot;</span>, <span class="st">&quot;EF&quot;</span>, <span class="st">&quot;EH&quot;</span>, <span class="st">&quot;EJ&quot;</span>,</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>    <span class="st">&quot;EK&quot;</span>, <span class="st">&quot;EM&quot;</span>, <span class="st">&quot;ES&quot;</span>, <span class="st">&quot;ET&quot;</span>, <span class="st">&quot;EX&quot;</span>, <span class="st">&quot;HA&quot;</span>, <span class="st">&quot;HB&quot;</span>, <span class="st">&quot;HE&quot;</span>, <span class="st">&quot;HF&quot;</span>, <span class="st">&quot;HL&quot;</span>, <span class="st">&quot;HM&quot;</span>, <span class="st">&quot;HO&quot;</span>, <span class="st">&quot;HT&quot;</span>,</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>    <span class="st">&quot;HU&quot;</span>, <span class="st">&quot;HX&quot;</span>, <span class="st">&quot;HY&quot;</span>, <span class="st">&quot;LD&quot;</span>, <span class="st">&quot;LN&quot;</span>, <span class="st">&quot;PF&quot;</span>, <span class="st">&quot;XB&quot;</span>, <span class="st">&quot;XC&quot;</span>, <span class="st">&quot;XE&quot;</span>), <span class="at">operator =</span> <span class="fu">c</span>(<span class="st">&quot;TransPennine Express&quot;</span>,</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>    <span class="st">&quot;Greater Anglia&quot;</span>, <span class="st">&quot;Grand Central&quot;</span>, <span class="st">&quot;Northern&quot;</span>, <span class="st">&quot;Heathrow Connect&quot;</span>, <span class="st">&quot;Great Western Railway&quot;</span>,</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>    <span class="st">&quot;CrossCountry&quot;</span>, <span class="st">&quot;West Midlands Railway&quot;</span>, <span class="st">&quot;London Overground&quot;</span>, <span class="st">&quot;East Midlands Railway&quot;</span>,</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>    <span class="st">&quot;Caledonian Sleeper&quot;</span>, <span class="st">&quot;Govia Thameslink Railway&quot;</span>, <span class="st">&quot;Elizabeth line&quot;</span>, <span class="st">&quot;ScotRail&quot;</span>,</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>    <span class="st">&quot;LNER&quot;</span>, <span class="st">&quot;Merseyrail&quot;</span>, <span class="st">&quot;Avanti West Coast&quot;</span>, <span class="st">&quot;Transport for Wales&quot;</span>, <span class="st">&quot;Heathrow Express&quot;</span>,</span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>    <span class="st">&quot;Chiltern Railways&quot;</span>, <span class="st">&quot;c2c&quot;</span>, <span class="st">&quot;Southeastern&quot;</span>, <span class="st">&quot;Thameslink&quot;</span>, <span class="st">&quot;South Western Railway&quot;</span>,</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>    <span class="st">&quot;Lumo&quot;</span>, <span class="st">&quot;London Northwestern Railway&quot;</span>, <span class="st">&quot;Hull Trains&quot;</span>, <span class="st">&quot;LUL District Line - Wimbledon&quot;</span>,</span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>    <span class="st">&quot;LUL Bakerloo Line&quot;</span>, <span class="st">&quot;LUL District Line - Richmond&quot;</span>))</span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a><span class="co"># Merge train operator data frame with the master data frame</span></span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>master_df <span class="ot">&lt;-</span> master_df <span class="sc">%&gt;%</span></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>    <span class="fu">left_join</span>(operators, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;toc_code&quot;</span>))</span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a><span class="co"># Read description for cancellation codes</span></span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>react_codes <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(<span class="st">&quot;data/glossary.xlsx&quot;</span>, <span class="at">sheet =</span> <span class="st">&quot;Reactionary Reason Code&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a>    <span class="co"># Convert column names to snake case</span></span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span></span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a>    <span class="co"># Drop the reason name column</span></span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a><span class="fu">select</span>(<span class="sc">-</span><span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a>    <span class="co"># Rename columns</span></span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">react_reason =</span> reactionary_reasons_reactionary_reason_code)</span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a><span class="co"># Merge cancellation codes data frame with the master data frame</span></span>
<span id="cb5-28"><a href="#cb5-28" tabindex="-1"></a>master_df <span class="ot">&lt;-</span> master_df <span class="sc">%&gt;%</span></span>
<span id="cb5-29"><a href="#cb5-29" tabindex="-1"></a>    <span class="fu">left_join</span>(react_codes, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;react_reason&quot;</span>))</span>
<span id="cb5-30"><a href="#cb5-30" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" tabindex="-1"></a><span class="co"># Read description for event types</span></span>
<span id="cb5-32"><a href="#cb5-32" tabindex="-1"></a>event_types <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(<span class="st">&quot;data/glossary.xlsx&quot;</span>, <span class="at">sheet =</span> <span class="st">&quot;Performance Event Code&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-33"><a href="#cb5-33" tabindex="-1"></a>    <span class="co"># Convert column names to snake case</span></span>
<span id="cb5-34"><a href="#cb5-34" tabindex="-1"></a><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span></span>
<span id="cb5-35"><a href="#cb5-35" tabindex="-1"></a>    <span class="co"># Drop the performance event column</span></span>
<span id="cb5-36"><a href="#cb5-36" tabindex="-1"></a><span class="fu">select</span>(<span class="sc">-</span><span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-37"><a href="#cb5-37" tabindex="-1"></a>    <span class="co"># Rename columns</span></span>
<span id="cb5-38"><a href="#cb5-38" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">event_type =</span> performance_event_types_performance_event_code)</span>
<span id="cb5-39"><a href="#cb5-39" tabindex="-1"></a></span>
<span id="cb5-40"><a href="#cb5-40" tabindex="-1"></a><span class="co"># Merge event types data frame with the master data frame</span></span>
<span id="cb5-41"><a href="#cb5-41" tabindex="-1"></a>master_df <span class="ot">&lt;-</span> master_df <span class="sc">%&gt;%</span></span>
<span id="cb5-42"><a href="#cb5-42" tabindex="-1"></a>    <span class="fu">left_join</span>(event_types, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;event_type&quot;</span>))</span>
<span id="cb5-43"><a href="#cb5-43" tabindex="-1"></a></span>
<span id="cb5-44"><a href="#cb5-44" tabindex="-1"></a><span class="co"># Rearrange columns for better readability</span></span>
<span id="cb5-45"><a href="#cb5-45" tabindex="-1"></a>master_df <span class="ot">&lt;-</span> master_df[, <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">8</span>, <span class="dv">4</span>, <span class="dv">7</span>, <span class="dv">2</span>, <span class="dv">6</span>, <span class="dv">5</span>)]</span>
<span id="cb5-46"><a href="#cb5-46" tabindex="-1"></a></span>
<span id="cb5-47"><a href="#cb5-47" tabindex="-1"></a><span class="co"># Save master data frame as a csv file</span></span>
<span id="cb5-48"><a href="#cb5-48" tabindex="-1"></a><span class="fu">write.csv</span>(master_df, <span class="st">&quot;data/masterfile.csv&quot;</span>)</span></code></pre></div>
</div>
</div>
<div id="visualisation" class="section level1" number="4">
<h1><span class="header-section-number">4</span> Visualisation</h1>
<p>Since the data set contains a huge amount of data (3,434,722
observations), deciding how to best present it took some trial and
error. After exploring various options, such as line graphs, choropleth
maps and heat maps, a spiral plot was chosen. A spiral plot maps
time-based data along an Archimedean spiral, which makes it ideal for
visualising large data sets over a large time period.</p>
<div id="count-cancellations" class="section level2" number="4.1">
<h2><span class="header-section-number">4.1</span> Count
Cancellations</h2>
<p>Before creating the plot some preparation is required. Since the
objective is to look at cancellations over time, a count of
cancellations by departure date is needed. To make sure the number of
cancellations is correct, a sanity check will be performed by comparing
the total sum with the number of observations in the master data
frame.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co"># Count the number of cancellations by date</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>train_count <span class="ot">&lt;-</span> master_df <span class="sc">%&gt;%</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>    <span class="fu">group_by</span>(departure_date) <span class="sc">%&gt;%</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>    <span class="fu">tally</span>()</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="co"># Sanity check, number of cancellations should equal number of observations in</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="co"># master data frame</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">sum</span>(train_count<span class="sc">$</span>n) <span class="sc">==</span> <span class="fu">nrow</span>(master_df))</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
</div>
<div id="creating-a-spiral-plot-function" class="section level2"
number="4.2">
<h2><span class="header-section-number">4.2</span> Creating a Spiral
Plot Function</h2>
<p>The next step is creating a function that maps the data along an
Archimedean spiral using the spiralize library.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="co"># Create a spiral plot function that requires the input of a data frame and a</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="co"># starting and ending date in the format &#39;YYYY-MM-DD&#39;. Refer to the</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="co"># documentation for the spiralize library for further details on its functions</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>spiral_plot <span class="ot">&lt;-</span> <span class="cf">function</span>(df, start, end) {</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>    <span class="co"># We&#39;ll use a temporary data frame to store the filtered date range</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>    temp_df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>        <span class="fu">filter</span>(departure_date <span class="sc">&gt;</span> start <span class="sc">&amp;</span> departure_date <span class="sc">&lt;</span> end)</span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>    <span class="co"># Initialize the spiral graph. As the spiral is 360 degrees, we have a</span></span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>    <span class="co"># choice to either normalize each year to 360 or to plot each year as</span></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>    <span class="co"># 365/366 days. Both options have their drawbacks and advantages</span></span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>    <span class="fu">spiral_initialize_by_time</span>(<span class="at">xlim =</span> <span class="fu">range</span>(temp_df<span class="sc">$</span>departure_date), <span class="at">verbose =</span> <span class="cn">FALSE</span>,</span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>        <span class="at">normalize_year =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a>    <span class="co"># Load data track. We set the range of the y axis to be slightly higher</span></span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a>    <span class="co"># than the maximum value</span></span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a>    <span class="fu">spiral_track</span>(<span class="at">height =</span> <span class="fl">0.8</span>, <span class="at">background =</span> <span class="cn">FALSE</span>, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.05</span> <span class="sc">*</span> <span class="fu">max</span>(temp_df<span class="sc">$</span>n)))</span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a>    <span class="co"># Draw backgrounds for the breakpoints. TRACK_META reads the meta data of</span></span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a>    <span class="co"># the current track</span></span>
<span id="cb8-22"><a href="#cb8-22" tabindex="-1"></a>    bg_col <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;#F8F8F8&quot;</span>, <span class="st">&quot;#F0F0F0&quot;</span>, <span class="st">&quot;#E8E8E8&quot;</span>, <span class="st">&quot;#E0E0E0&quot;</span>)</span>
<span id="cb8-23"><a href="#cb8-23" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>) {</span>
<span id="cb8-24"><a href="#cb8-24" tabindex="-1"></a>        <span class="fu">spiral_rect</span>(TRACK_META<span class="sc">$</span>xlim[<span class="dv">1</span>], TRACK_META<span class="sc">$</span>ylim[<span class="dv">1</span>] <span class="sc">+</span> TRACK_META<span class="sc">$</span>yrange <span class="sc">*</span></span>
<span id="cb8-25"><a href="#cb8-25" tabindex="-1"></a>            (i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">/</span><span class="dv">4</span>, TRACK_META<span class="sc">$</span>xlim[<span class="dv">2</span>], TRACK_META<span class="sc">$</span>ylim[<span class="dv">1</span>] <span class="sc">+</span> TRACK_META<span class="sc">$</span>yrange <span class="sc">*</span></span>
<span id="cb8-26"><a href="#cb8-26" tabindex="-1"></a>            i<span class="sc">/</span><span class="dv">4</span>, <span class="at">gp =</span> <span class="fu">gpar</span>(<span class="at">fill =</span> bg_col[i], <span class="at">col =</span> <span class="cn">NA</span>))</span>
<span id="cb8-27"><a href="#cb8-27" tabindex="-1"></a>    }</span>
<span id="cb8-28"><a href="#cb8-28" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" tabindex="-1"></a>    <span class="co"># Draw bar plot</span></span>
<span id="cb8-30"><a href="#cb8-30" tabindex="-1"></a>    <span class="fu">spiral_bars</span>(temp_df<span class="sc">$</span>departure_date, temp_df<span class="sc">$</span>n, <span class="at">gp =</span> <span class="fu">gpar</span>(<span class="at">fill =</span> <span class="dv">4</span>, <span class="at">col =</span> <span class="dv">4</span>))</span>
<span id="cb8-31"><a href="#cb8-31" tabindex="-1"></a></span>
<span id="cb8-32"><a href="#cb8-32" tabindex="-1"></a>    <span class="co"># Create unit labels</span></span>
<span id="cb8-33"><a href="#cb8-33" tabindex="-1"></a></span>
<span id="cb8-34"><a href="#cb8-34" tabindex="-1"></a>    <span class="co"># Read the maximum value of the y axis</span></span>
<span id="cb8-35"><a href="#cb8-35" tabindex="-1"></a>    max <span class="ot">=</span> TRACK_META<span class="sc">$</span>ymax</span>
<span id="cb8-36"><a href="#cb8-36" tabindex="-1"></a>    <span class="co"># Set the start point as 0 and the end point as max</span></span>
<span id="cb8-37"><a href="#cb8-37" tabindex="-1"></a>    at <span class="ot">=</span> <span class="fu">grid.pretty</span>(<span class="fu">c</span>(<span class="dv">0</span>, max))</span>
<span id="cb8-38"><a href="#cb8-38" tabindex="-1"></a>    <span class="co"># Create breakpoints between 0 and max</span></span>
<span id="cb8-39"><a href="#cb8-39" tabindex="-1"></a>    at <span class="ot">=</span> at[at <span class="sc">&lt;=</span> max]</span>
<span id="cb8-40"><a href="#cb8-40" tabindex="-1"></a>    <span class="co"># Place the labels along the y axis</span></span>
<span id="cb8-41"><a href="#cb8-41" tabindex="-1"></a>    labels <span class="ot">=</span> <span class="fu">as.character</span>(at)</span>
<span id="cb8-42"><a href="#cb8-42" tabindex="-1"></a>    <span class="co"># Add a K label to indicate thousands</span></span>
<span id="cb8-43"><a href="#cb8-43" tabindex="-1"></a>    labels[at <span class="sc">&gt;=</span> <span class="dv">1000</span> <span class="sc">&amp;</span> at <span class="sc">&lt;</span> <span class="fl">1e+06</span>] <span class="ot">=</span> <span class="fu">paste0</span>(at[at <span class="sc">&gt;=</span> <span class="dv">1000</span> <span class="sc">&amp;</span> at <span class="sc">&lt;</span> <span class="fl">1e+06</span>]<span class="sc">/</span><span class="dv">1000</span>, <span class="st">&quot;K&quot;</span>)</span>
<span id="cb8-44"><a href="#cb8-44" tabindex="-1"></a>    <span class="co"># Draw it at the beginning and end of the spiral</span></span>
<span id="cb8-45"><a href="#cb8-45" tabindex="-1"></a>    <span class="fu">spiral_yaxis</span>(<span class="at">at =</span> at, <span class="at">labels =</span> labels, <span class="at">labels_gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">5</span>))</span>
<span id="cb8-46"><a href="#cb8-46" tabindex="-1"></a></span>
<span id="cb8-47"><a href="#cb8-47" tabindex="-1"></a>    <span class="co"># Create month and year labels</span></span>
<span id="cb8-48"><a href="#cb8-48" tabindex="-1"></a></span>
<span id="cb8-49"><a href="#cb8-49" tabindex="-1"></a>    <span class="co"># Read the final date in the range</span></span>
<span id="cb8-50"><a href="#cb8-50" tabindex="-1"></a>    dd <span class="ot">=</span> <span class="fu">max</span>(temp_df<span class="sc">$</span>departure_date)</span>
<span id="cb8-51"><a href="#cb8-51" tabindex="-1"></a>    <span class="co"># Set the day to the 15th as a midpoint</span></span>
<span id="cb8-52"><a href="#cb8-52" tabindex="-1"></a>    <span class="fu">day</span>(dd) <span class="ot">=</span> <span class="dv">15</span></span>
<span id="cb8-53"><a href="#cb8-53" tabindex="-1"></a>    <span class="co"># Add the months</span></span>
<span id="cb8-54"><a href="#cb8-54" tabindex="-1"></a>    dd <span class="ot">=</span> dd <span class="sc">+</span> <span class="fu">months</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>)</span>
<span id="cb8-55"><a href="#cb8-55" tabindex="-1"></a>    <span class="co"># Draw the labels</span></span>
<span id="cb8-56"><a href="#cb8-56" tabindex="-1"></a>    <span class="fu">spiral_text</span>(dd, <span class="at">y =</span> <span class="fl">1.5</span>, month.name[<span class="fu">month</span>(dd)], <span class="at">facing =</span> <span class="st">&quot;inside&quot;</span>, <span class="at">nice_facing =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-57"><a href="#cb8-57" tabindex="-1"></a></span>
<span id="cb8-58"><a href="#cb8-58" tabindex="-1"></a>    <span class="co"># Create a vector with the years in the date range</span></span>
<span id="cb8-59"><a href="#cb8-59" tabindex="-1"></a>    years <span class="ot">=</span> <span class="fu">as.character</span>(<span class="fu">unique</span>(<span class="fu">year</span>(temp_df<span class="sc">$</span>departure_date)))</span>
<span id="cb8-60"><a href="#cb8-60" tabindex="-1"></a></span>
<span id="cb8-61"><a href="#cb8-61" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(years)) {</span>
<span id="cb8-62"><a href="#cb8-62" tabindex="-1"></a>        <span class="co"># Place a year label on January 1st of each year</span></span>
<span id="cb8-63"><a href="#cb8-63" tabindex="-1"></a>        <span class="fu">spiral_text</span>(<span class="fu">sprintf</span>(<span class="st">&quot;%s-01-01&quot;</span>, years[i]), TRACK_META<span class="sc">$</span>ycenter, years[i],</span>
<span id="cb8-64"><a href="#cb8-64" tabindex="-1"></a>            <span class="at">gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">8</span>))</span>
<span id="cb8-65"><a href="#cb8-65" tabindex="-1"></a>    }</span>
<span id="cb8-66"><a href="#cb8-66" tabindex="-1"></a></span>
<span id="cb8-67"><a href="#cb8-67" tabindex="-1"></a>    <span class="co"># Create the title</span></span>
<span id="cb8-68"><a href="#cb8-68" tabindex="-1"></a>    <span class="fu">grid.text</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Train cancellations in Great Britain, %s-%s&quot;</span>, <span class="fu">first</span>(years),</span>
<span id="cb8-69"><a href="#cb8-69" tabindex="-1"></a>        <span class="fu">last</span>(years)), <span class="at">x =</span> <span class="fu">unit</span>(<span class="dv">0</span>, <span class="st">&quot;npc&quot;</span>) <span class="sc">+</span> <span class="fu">unit</span>(<span class="dv">0</span>, <span class="st">&quot;mm&quot;</span>), <span class="at">y =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">&quot;npc&quot;</span>) <span class="sc">-</span> <span class="fu">unit</span>(<span class="dv">0</span>,</span>
<span id="cb8-70"><a href="#cb8-70" tabindex="-1"></a>        <span class="st">&quot;mm&quot;</span>), <span class="at">gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">14</span>))</span>
<span id="cb8-71"><a href="#cb8-71" tabindex="-1"></a></span>
<span id="cb8-72"><a href="#cb8-72" tabindex="-1"></a>    <span class="co"># Add source</span></span>
<span id="cb8-73"><a href="#cb8-73" tabindex="-1"></a>    <span class="fu">grid.text</span>(<span class="st">&quot;Source: NWR Historic Delay Attribution licensed under OGL v3.0.&quot;</span>,</span>
<span id="cb8-74"><a href="#cb8-74" tabindex="-1"></a>        <span class="at">x =</span> <span class="fu">unit</span>(<span class="dv">0</span>, <span class="st">&quot;npc&quot;</span>) <span class="sc">+</span> <span class="fu">unit</span>(<span class="dv">0</span>, <span class="st">&quot;mm&quot;</span>), <span class="at">y =</span> <span class="fu">unit</span>(<span class="dv">0</span>, <span class="st">&quot;npc&quot;</span>) <span class="sc">-</span> <span class="fu">unit</span>(<span class="dv">0</span>, <span class="st">&quot;mm&quot;</span>), <span class="at">gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">8</span>))</span>
<span id="cb8-75"><a href="#cb8-75" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="plotting-the-data" class="section level2" number="4.3">
<h2><span class="header-section-number">4.3</span> Plotting the
Data</h2>
<p>Now that the function has been created, plots of any date range
within the data frame can easily be drawn. To test it out, a plot of the
entire data set is drawn.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co"># Draw the plot</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="fu">spiral_plot</span>(train_count, <span class="st">&quot;2015-04-01&quot;</span>, <span class="st">&quot;2024-10-12&quot;</span>)</span></code></pre></div>
<p><img src="figs/spiral_plot.svg"/> <br /><br /></p>
<p>Unfortunately, it looks like there is a bit of an information
overload going on here, so readability is not great. The drawback of
plotting 365/366 day years on a 360 degree spiral can also be seen as
the years are drifting and not aligning correctly with the months.</p>
</div>
<div id="improving-the-plot" class="section level2" number="4.4">
<h2><span class="header-section-number">4.4</span> Improving the
Plot</h2>
<p>The first idea for improving the plotting was to split it into three
plots covering roughly three years each.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="co"># Draw the plots</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="fu">spiral_plot</span>(train_count, <span class="st">&quot;2015-04-01&quot;</span>, <span class="st">&quot;2017-12-31&quot;</span>)</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="fu">spiral_plot</span>(train_count, <span class="st">&quot;2018-01-01&quot;</span>, <span class="st">&quot;2020-12-31&quot;</span>)</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="fu">spiral_plot</span>(train_count, <span class="st">&quot;2021-01-01&quot;</span>, <span class="st">&quot;2024-10-12&quot;</span>)</span></code></pre></div>
<p><img src="figs/2015_2017.svg"/></p>
<p><img src="figs/2018_2020.svg"/></p>
<p><img src="figs/2021_2024.svg"/> <br /><br /></p>
<p>Better, but still problematic. There is still some drift of the years
and there are uneven distributions. The first year label is also
obscuring the unit labels on two of the plots.</p>
</div>
<div id="improving-the-plot-2-electric-boogaloo" class="section level2"
number="4.5">
<h2><span class="header-section-number">4.5</span> Improving the Plot 2:
Electric Boogaloo</h2>
<p>The next idea was to draw each year separately and then put all the
plots into a grid. To do this, the plotting function has to be revisited
and modified slightly. The most important modification is adding a
vector that will hold the maximum y axis value for the entire data set.
Without setting this the plots would end up being on different scales,
which would make the grid appear visually deceptive as well as making
comparisons needlessly difficult. A label that displays the total amount
of cancellations per year has also been added.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="do">## Draw a grid of all years</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>grid_plot <span class="ot">&lt;-</span> <span class="cf">function</span>(df, start, end) {</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>    <span class="co"># Store the maximum y axis value for the entire data set</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>    y_maximum <span class="ot">=</span> <span class="fu">max</span>(df<span class="sc">$</span>n)</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>    <span class="co"># We&#39;ll use a temporary data frame to store the filtered date range</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>    temp_df <span class="ot">&lt;-</span> train_count <span class="sc">%&gt;%</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>        <span class="fu">filter</span>(departure_date <span class="sc">&gt;</span> start <span class="sc">&amp;</span> departure_date <span class="sc">&lt;</span> end)</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>    <span class="co"># Initialize the spiral graph. As the spiral is 360 degrees, we have a</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>    <span class="co"># choice to either normalize each year to 360 or to plot each year as</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>    <span class="co"># 365/366 days. Both options have their drawbacks and advantages</span></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>    <span class="fu">spiral_initialize_by_time</span>(<span class="at">xlim =</span> <span class="fu">range</span>(temp_df<span class="sc">$</span>departure_date), <span class="at">verbose =</span> <span class="cn">FALSE</span>,</span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>        <span class="at">normalize_year =</span> <span class="cn">FALSE</span>)</span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>    <span class="co"># Load data track. Since we&#39;re now plotting each year separately, we change</span></span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>    <span class="co"># the y max to the maximum for the entire data set</span></span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a>    <span class="fu">spiral_track</span>(<span class="at">height =</span> <span class="fl">0.8</span>, <span class="at">background =</span> <span class="cn">FALSE</span>, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.05</span> <span class="sc">*</span> <span class="fu">max</span>(y_maximum)))</span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a>    <span class="co"># Draw backgrounds for the breakpoints. TRACK_META reads the meta data of</span></span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a>    <span class="co"># the current track</span></span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a>    bg_col <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;#F8F8F8&quot;</span>, <span class="st">&quot;#F0F0F0&quot;</span>, <span class="st">&quot;#E8E8E8&quot;</span>, <span class="st">&quot;#E0E0E0&quot;</span>)</span>
<span id="cb11-24"><a href="#cb11-24" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>) {</span>
<span id="cb11-25"><a href="#cb11-25" tabindex="-1"></a>        <span class="fu">spiral_rect</span>(TRACK_META<span class="sc">$</span>xlim[<span class="dv">1</span>], TRACK_META<span class="sc">$</span>ylim[<span class="dv">1</span>] <span class="sc">+</span> TRACK_META<span class="sc">$</span>yrange <span class="sc">*</span></span>
<span id="cb11-26"><a href="#cb11-26" tabindex="-1"></a>            (i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">/</span><span class="dv">4</span>, TRACK_META<span class="sc">$</span>xlim[<span class="dv">2</span>], TRACK_META<span class="sc">$</span>ylim[<span class="dv">1</span>] <span class="sc">+</span> TRACK_META<span class="sc">$</span>yrange <span class="sc">*</span></span>
<span id="cb11-27"><a href="#cb11-27" tabindex="-1"></a>            i<span class="sc">/</span><span class="dv">4</span>, <span class="at">gp =</span> <span class="fu">gpar</span>(<span class="at">fill =</span> bg_col[i], <span class="at">col =</span> <span class="cn">NA</span>))</span>
<span id="cb11-28"><a href="#cb11-28" tabindex="-1"></a>    }</span>
<span id="cb11-29"><a href="#cb11-29" tabindex="-1"></a></span>
<span id="cb11-30"><a href="#cb11-30" tabindex="-1"></a>    <span class="co"># Draw bar plot</span></span>
<span id="cb11-31"><a href="#cb11-31" tabindex="-1"></a>    <span class="fu">spiral_bars</span>(temp_df<span class="sc">$</span>departure_date, temp_df<span class="sc">$</span>n, <span class="at">gp =</span> <span class="fu">gpar</span>(<span class="at">fill =</span> <span class="dv">4</span>, <span class="at">col =</span> <span class="dv">4</span>))</span>
<span id="cb11-32"><a href="#cb11-32" tabindex="-1"></a></span>
<span id="cb11-33"><a href="#cb11-33" tabindex="-1"></a>    <span class="co"># Create unit labels</span></span>
<span id="cb11-34"><a href="#cb11-34" tabindex="-1"></a></span>
<span id="cb11-35"><a href="#cb11-35" tabindex="-1"></a>    <span class="co"># Read the maximum value of the y axis</span></span>
<span id="cb11-36"><a href="#cb11-36" tabindex="-1"></a>    max <span class="ot">=</span> TRACK_META<span class="sc">$</span>ymax</span>
<span id="cb11-37"><a href="#cb11-37" tabindex="-1"></a>    <span class="co"># Set the start point as 0 and the end point as max</span></span>
<span id="cb11-38"><a href="#cb11-38" tabindex="-1"></a>    at <span class="ot">=</span> <span class="fu">grid.pretty</span>(<span class="fu">c</span>(<span class="dv">0</span>, max))</span>
<span id="cb11-39"><a href="#cb11-39" tabindex="-1"></a>    <span class="co"># Create breakpoints between 0 and max</span></span>
<span id="cb11-40"><a href="#cb11-40" tabindex="-1"></a>    at <span class="ot">=</span> at[at <span class="sc">&lt;=</span> max]</span>
<span id="cb11-41"><a href="#cb11-41" tabindex="-1"></a>    <span class="co"># Place the labels along the y axis</span></span>
<span id="cb11-42"><a href="#cb11-42" tabindex="-1"></a>    labels <span class="ot">=</span> <span class="fu">as.character</span>(at)</span>
<span id="cb11-43"><a href="#cb11-43" tabindex="-1"></a>    <span class="co"># Add a K label to indicate thousands</span></span>
<span id="cb11-44"><a href="#cb11-44" tabindex="-1"></a>    labels[at <span class="sc">&gt;=</span> <span class="dv">1000</span> <span class="sc">&amp;</span> at <span class="sc">&lt;</span> <span class="fl">1e+06</span>] <span class="ot">=</span> <span class="fu">paste0</span>(at[at <span class="sc">&gt;=</span> <span class="dv">1000</span> <span class="sc">&amp;</span> at <span class="sc">&lt;</span> <span class="fl">1e+06</span>]<span class="sc">/</span><span class="dv">1000</span>, <span class="st">&quot;K&quot;</span>)</span>
<span id="cb11-45"><a href="#cb11-45" tabindex="-1"></a>    <span class="co"># Draw it at the beginning and end of the spiral</span></span>
<span id="cb11-46"><a href="#cb11-46" tabindex="-1"></a>    <span class="fu">spiral_yaxis</span>(<span class="at">at =</span> at, <span class="at">labels =</span> labels, <span class="at">labels_gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">5</span>))</span>
<span id="cb11-47"><a href="#cb11-47" tabindex="-1"></a></span>
<span id="cb11-48"><a href="#cb11-48" tabindex="-1"></a>    <span class="co"># Create month and year labels</span></span>
<span id="cb11-49"><a href="#cb11-49" tabindex="-1"></a></span>
<span id="cb11-50"><a href="#cb11-50" tabindex="-1"></a>    <span class="co"># Read the final date in the range</span></span>
<span id="cb11-51"><a href="#cb11-51" tabindex="-1"></a>    dd <span class="ot">=</span> <span class="fu">max</span>(temp_df<span class="sc">$</span>departure_date)</span>
<span id="cb11-52"><a href="#cb11-52" tabindex="-1"></a>    <span class="co"># Set the day to the 15th as a midpoint</span></span>
<span id="cb11-53"><a href="#cb11-53" tabindex="-1"></a>    <span class="fu">day</span>(dd) <span class="ot">=</span> <span class="dv">15</span></span>
<span id="cb11-54"><a href="#cb11-54" tabindex="-1"></a>    <span class="co"># Add the months</span></span>
<span id="cb11-55"><a href="#cb11-55" tabindex="-1"></a>    dd <span class="ot">=</span> dd <span class="sc">+</span> <span class="fu">months</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>)</span>
<span id="cb11-56"><a href="#cb11-56" tabindex="-1"></a>    <span class="co"># Draw the labels</span></span>
<span id="cb11-57"><a href="#cb11-57" tabindex="-1"></a>    <span class="fu">spiral_text</span>(dd, <span class="at">y =</span> <span class="fl">1.5</span>, month.name[<span class="fu">month</span>(dd)], <span class="at">facing =</span> <span class="st">&quot;inside&quot;</span>, <span class="at">nice_facing =</span> <span class="cn">TRUE</span>,</span>
<span id="cb11-58"><a href="#cb11-58" tabindex="-1"></a>        <span class="at">gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">8</span>))</span>
<span id="cb11-59"><a href="#cb11-59" tabindex="-1"></a></span>
<span id="cb11-60"><a href="#cb11-60" tabindex="-1"></a>    <span class="co"># Create a vector with the years in the date range</span></span>
<span id="cb11-61"><a href="#cb11-61" tabindex="-1"></a>    years <span class="ot">=</span> <span class="fu">as.character</span>(<span class="fu">unique</span>(<span class="fu">year</span>(temp_df<span class="sc">$</span>departure_date)))</span>
<span id="cb11-62"><a href="#cb11-62" tabindex="-1"></a></span>
<span id="cb11-63"><a href="#cb11-63" tabindex="-1"></a>    <span class="co"># Create the title</span></span>
<span id="cb11-64"><a href="#cb11-64" tabindex="-1"></a>    <span class="fu">grid.text</span>(<span class="fu">sprintf</span>(<span class="st">&quot;%s&quot;</span>, years), <span class="at">x =</span> <span class="fu">unit</span>(<span class="dv">0</span>, <span class="st">&quot;npc&quot;</span>) <span class="sc">+</span> <span class="fu">unit</span>(<span class="dv">0</span>, <span class="st">&quot;mm&quot;</span>), <span class="at">y =</span> <span class="fu">unit</span>(<span class="dv">1</span>,</span>
<span id="cb11-65"><a href="#cb11-65" tabindex="-1"></a>        <span class="st">&quot;npc&quot;</span>) <span class="sc">-</span> <span class="fu">unit</span>(<span class="dv">0</span>, <span class="st">&quot;mm&quot;</span>), <span class="at">gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">14</span>))</span>
<span id="cb11-66"><a href="#cb11-66" tabindex="-1"></a></span>
<span id="cb11-67"><a href="#cb11-67" tabindex="-1"></a>    <span class="co"># Add number of cancellations</span></span>
<span id="cb11-68"><a href="#cb11-68" tabindex="-1"></a>    <span class="fu">grid.text</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Total cancellations: %s&quot;</span>, <span class="fu">format</span>(<span class="fu">sum</span>(temp_df<span class="sc">$</span>n), <span class="at">big.mark =</span> <span class="st">&quot;,&quot;</span>)),</span>
<span id="cb11-69"><a href="#cb11-69" tabindex="-1"></a>        <span class="at">x =</span> <span class="fu">unit</span>(<span class="dv">0</span>, <span class="st">&quot;npc&quot;</span>) <span class="sc">+</span> <span class="fu">unit</span>(<span class="sc">-</span><span class="dv">6</span>, <span class="st">&quot;mm&quot;</span>), <span class="at">y =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">&quot;npc&quot;</span>) <span class="sc">-</span> <span class="fu">unit</span>(<span class="dv">5</span>, <span class="st">&quot;mm&quot;</span>),</span>
<span id="cb11-70"><a href="#cb11-70" tabindex="-1"></a>        <span class="at">just =</span> <span class="st">&quot;left&quot;</span>, <span class="at">gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">8</span>))</span>
<span id="cb11-71"><a href="#cb11-71" tabindex="-1"></a>}</span></code></pre></div>
<p>After modifying the function some vectors need to be defined. These
will hold the ranges of dates that will be used to draw a plot of each
year.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="co"># Count the number of years and create lists of start and end dates</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>yrs <span class="ot">=</span> <span class="fu">as.character</span>(<span class="fu">unique</span>(<span class="fu">year</span>(train_count<span class="sc">$</span>departure_date)))</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>start <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;2015-04-01&quot;</span>, <span class="st">&quot;2016-01-01&quot;</span>, <span class="st">&quot;2017-01-01&quot;</span>, <span class="st">&quot;2018-01-01&quot;</span>, <span class="st">&quot;2019-01-01&quot;</span>, <span class="st">&quot;2020-01-01&quot;</span>,</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>    <span class="st">&quot;2021-01-01&quot;</span>, <span class="st">&quot;2022-01-01&quot;</span>, <span class="st">&quot;2023-01-01&quot;</span>, <span class="st">&quot;2024-01-01&quot;</span>)</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>end <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;2015-12-31&quot;</span>, <span class="st">&quot;2016-12-31&quot;</span>, <span class="st">&quot;2017-12-31&quot;</span>, <span class="st">&quot;2018-12-31&quot;</span>, <span class="st">&quot;2019-12-31&quot;</span>, <span class="st">&quot;2020-12-31&quot;</span>,</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>    <span class="st">&quot;2021-12-31&quot;</span>, <span class="st">&quot;2022-12-31&quot;</span>, <span class="st">&quot;2023-12-31&quot;</span>, <span class="st">&quot;2024-10-12&quot;</span>)</span></code></pre></div>
<p>Next, these vectors can be fed into a loop that populates a list of
plots.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="co"># Create a list to be populated</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>pl <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="co"># Run a loop to populate the list</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(yrs)) {</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>    pl[[i]] <span class="ot">&lt;-</span> <span class="fu">grid.grabExpr</span>({</span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>        <span class="fu">grid_plot</span>(train_count, start[i], end[i])</span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>    })</span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>}</span></code></pre></div>
<p>Finally, the plots are combined into a grid and have a title and a
source attribution added.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="co"># Create the title</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>title <span class="ot">&lt;-</span> <span class="fu">ggdraw</span>() <span class="sc">+</span> <span class="fu">draw_label</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Train cancellations in Great Britain, %s-%s&quot;</span>,</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>    <span class="fu">first</span>(yrs), <span class="fu">last</span>(yrs)), <span class="at">fontface =</span> <span class="st">&quot;bold&quot;</span>, <span class="at">size =</span> <span class="dv">20</span>, <span class="at">x =</span> <span class="dv">0</span>, <span class="at">hjust =</span> <span class="dv">0</span>) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="dv">0</span>,</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>    <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">7</span>))</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a><span class="co"># Plot the grid of years</span></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>plot_row <span class="ot">&lt;-</span> <span class="fu">plot_grid</span>(<span class="at">plotlist =</span> pl, <span class="at">ncol =</span> <span class="dv">4</span>)</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a><span class="co"># Combine title with grid of years</span></span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a><span class="fu">plot_grid</span>(title, plot_row, <span class="at">ncol =</span> <span class="dv">1</span>, <span class="at">rel_heights =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="dv">1</span>))</span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a><span class="co"># Add source attribution</span></span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a><span class="fu">grid.text</span>(<span class="st">&quot;Source: NWR Historic Delay Attribution licensed under the Open Government Licence v3.0.&quot;</span>,</span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">unit</span>(<span class="fl">0.6</span>, <span class="st">&quot;npc&quot;</span>) <span class="sc">+</span> <span class="fu">unit</span>(<span class="dv">10</span>, <span class="st">&quot;mm&quot;</span>), <span class="at">y =</span> <span class="fu">unit</span>(<span class="fl">0.25</span>, <span class="st">&quot;npc&quot;</span>) <span class="sc">-</span> <span class="fu">unit</span>(<span class="dv">0</span>, <span class="st">&quot;mm&quot;</span>),</span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a>    <span class="at">gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">8</span>))</span></code></pre></div>
<p><!-- Trigger the Modal -->
<img src="figs/all_years.svg" alt="Grid plot" id="myImg"/></p>
<!-- The Modal -->
<div id="myModal" class="modal">
<p><!-- The Close Button --> <span class="closeimg">×</span></p>
<p><!-- Modal Content (The Image) -->
<img class="modal-content" id="img01"></p>
<!-- Modal Caption (Image Text) -->
<div id="caption">

</div>
</div>
<script>
// Get the modal
var modal = document.getElementById('myModal');

// Get the image and insert it inside the modal - use its "alt" text as a caption
var img = document.getElementById('myImg');
var modalImg = document.getElementById("img01");
var captionText = document.getElementById("caption");
img.onclick = function(){
  modal.style.display = "block";
  modalImg.src = this.src;
  captionText.innerHTML = this.alt;
}

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("closeimg")[0];

// When the user clicks on <span> (x), close the modal
span.onclick = function() { 
  modal.style.display = "none";
}
</script>
<div class="info">
<p><em>Click on the figure to see it in a higher resolution.</em></p>
</div>
</div>
<div id="saving-the-final-visualisation" class="section level2"
number="4.6">
<h2><span class="header-section-number">4.6</span> Saving the Final
Visualisation</h2>
<p>The final visualisation is saved as an svg file, which allows for
scaling without loss of information.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="co"># Save the grid plot</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="fu">svg</span>(<span class="st">&quot;figs/all_years.svg&quot;</span>, <span class="at">width =</span> <span class="dv">20</span>, <span class="at">height =</span> <span class="dv">15</span>)</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="fu">plot_grid</span>(title, plot_row, <span class="at">ncol =</span> <span class="dv">1</span>, <span class="at">rel_heights =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="dv">1</span>))</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="fu">grid.text</span>(<span class="st">&quot;Source: NWR Historic Delay Attribution licensed under the Open Government Licence v3.0.&quot;</span>,</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">unit</span>(<span class="fl">0.6</span>, <span class="st">&quot;npc&quot;</span>) <span class="sc">+</span> <span class="fu">unit</span>(<span class="dv">10</span>, <span class="st">&quot;mm&quot;</span>), <span class="at">y =</span> <span class="fu">unit</span>(<span class="fl">0.25</span>, <span class="st">&quot;npc&quot;</span>) <span class="sc">-</span> <span class="fu">unit</span>(<span class="dv">0</span>, <span class="st">&quot;mm&quot;</span>),</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>    <span class="at">gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">8</span>))</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">dev.off</span>())</span></code></pre></div>
</div>
</div>
<div id="summary" class="section level1" number="5">
<h1><span class="header-section-number">5</span> Summary</h1>
<div id="interpretation" class="section level2" number="5.1">
<h2><span class="header-section-number">5.1</span> Interpretation</h2>
<p>The most obvious conclusion one can draw by looking at the data is
that the number of cancellations have been steadily increasing over the
years. This could be due to any number of reasons, but by looking into
some of the highest spikes throughout the years, it seems that extreme
weather events are at least partially responsible. Below is a list of
some of the most severe spikes and corresponding weather events:</p>
<table class="striped">
<thead>
<tr>
<th style="text-align:left;">
Date
</th>
<th style="text-align:left;">
Cancellations
</th>
<th style="text-align:left;">
Weather Event
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
June 23rd, 2016
</td>
<td style="text-align:left;">
4749
</td>
<td style="text-align:left;">
Severe flooding
</td>
</tr>
<tr>
<td style="text-align:left;">
February 23rd, 2017
</td>
<td style="text-align:left;">
5007
</td>
<td style="text-align:left;">
Storm Doris
</td>
</tr>
<tr>
<td style="text-align:left;">
February 26th-March 3rd, 2018
</td>
<td style="text-align:left;">
22,627
</td>
<td style="text-align:left;">
Extreme cold spell
</td>
</tr>
<tr>
<td style="text-align:left;">
September 19th-21st, 2018
</td>
<td style="text-align:left;">
5720
</td>
<td style="text-align:left;">
Storms Ali and Bronagh
</td>
</tr>
<tr>
<td style="text-align:left;">
November 26th-27th, 2021
</td>
<td style="text-align:left;">
6082
</td>
<td style="text-align:left;">
Storm Arwen
</td>
</tr>
<tr>
<td style="text-align:left;">
February 16th-21st, 2022
</td>
<td style="text-align:left;">
25,116
</td>
<td style="text-align:left;">
Storms Dudley, Eunice and Franklin
</td>
</tr>
<tr>
<td style="text-align:left;">
February 16th-21st, 2022
</td>
<td style="text-align:left;">
15,005
</td>
<td style="text-align:left;">
Extreme heatwave
</td>
</tr>
<tr>
<td style="text-align:left;">
December 8th-18th, 2022
</td>
<td style="text-align:left;">
21,236
</td>
<td style="text-align:left;">
Extreme cold spell
</td>
</tr>
<tr>
<td style="text-align:left;">
January 2nd, 2024
</td>
<td style="text-align:left;">
5482
</td>
<td style="text-align:left;">
Storm Henk
</td>
</tr>
</tbody>
</table>
<p>The weather data in this table is sourced from the UK Storm Centre
<span class="citation">(<a href="#ref-MetStorms">Met Office,
2024b</a>)</span> and case studies of past weather events <span
class="citation">(<a href="#ref-MetWeather">Met Office,
2024a</a>)</span> on the Met Office website.</p>
</div>
<div id="limitations" class="section level2" number="5.2">
<h2><span class="header-section-number">5.2</span> Limitations</h2>
<p>Throughout this project, the number one glaring limitation has been
the inability to normalise the data. Whilst the Office of Rail and Road
has a <a
href="https://dataportal.orr.gov.uk/statistics/performance/passenger-rail-performance/table-3124-trains-planned-and-cancellations-by-operator-and-cause-periodic/">data
set</a> on train cancellations that includes the number of planned
trains, it is not as granular as the delay and cancellation data set
from the Rail Data Marketplace. Furthermore, it only contains data
starting with the 2019-2020 fiscal year, and the data is organised by
period rather than by date. Without the possibility to normalise the
data, it is impossible to tell whether certain regions or stations are
more impacted by cancellations than others.</p>
<p>Another limitation with the data is the fact that just over one third
of the cancellations (1,171,651) are coded as “OU - Delays not
investigated by Network Rail”. These are cancellations that were not
investigated on the date of occurrence and subsequently failed to be
investigated within contractual timescales (seven calendar days). Thus,
any visualisations on the reasons for cancellations would not be telling
the whole story.</p>
</div>
<div id="follow-ups" class="section level2" number="5.3">
<h2><span class="header-section-number">5.3</span> Follow-ups</h2>
<p>This data set has a wealth of information and could be visualised in
a variety of ways. It could for instance be used to compare the
differences in the number of cancellations by train operators or it
could be used to plot the number of cancellations by routes or regions.
Another follow-up could be to look closer into the correlations between
cancellations and weather events and whether the frequency of
cancellations caused by weather events is increasing. Can climate change
be tracked via train cancellations?</p>
</div>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="unnumbered">References</h1>
<div id="refs" class="references csl-bib-body hanging-indent"
entry-spacing="0" line-spacing="2">
<div id="ref-MetWeather" class="csl-entry">
Met Office. (2024a). <em>Past weather events</em>. Met Office. <a
href="https://www.metoffice.gov.uk/weather/learn-about/past-uk-weather-events">https://www.metoffice.gov.uk/weather/learn-about/past-uk-weather-events</a>
</div>
<div id="ref-MetStorms" class="csl-entry">
Met Office. (2024b). <em>UK storm centre</em>. Met Office. <a
href="https://www.metoffice.gov.uk/weather/warnings-and-advice/uk-storm-centre/index">https://www.metoffice.gov.uk/weather/warnings-and-advice/uk-storm-centre/index</a>
</div>
<div id="ref-NWRDelay" class="csl-entry">
Rail Delivery Group. (2024). <em>NWR historic delay attribution</em>.
RSP Limited. <a
href="https://raildata.org.uk/dashboard/dataProduct/P-3fade1ab-0a85-4ac6-bc51-17c770350af3/dataFiles">https://raildata.org.uk/dashboard/dataProduct/P-3fade1ab-0a85-4ac6-bc51-17c770350af3/dataFiles</a>
</div>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
